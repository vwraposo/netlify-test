"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const parser_1 = require("@babel/parser");
// Creates getTheme function so theme-ui does not try to deep merge the theme in here
// https://github.com/system-ui/theme-ui/blob/bfba2df8fdd01119c3af6a233355db1955c54ba0/packages/core/src/index.js#L87
const template = (serialized) => `
function getTheme () { return JSON.parse(${serialized}); };
export default getTheme;
`;
const plugin = (_, options) => {
    const { inFile, inPath } = options;
    const { theme } = global;
    const visitor = {
        Program: (path, state) => {
            const { file: { opts: { filename }, }, } = state;
            if (filename === inFile) {
                // Stringify twice to make sure the strings are correctly scaped. For more info:
                // https://stackoverflow.com/questions/5506000/json-stringify-doesnt-escape
                const serialized = JSON.stringify(JSON.stringify(theme));
                const parsed = parser_1.parse(template(serialized), {
                    sourceType: 'module',
                });
                path.replaceWith(parsed.program);
                path.skip();
            }
            else if (filename.startsWith(inPath)) {
                path.remove();
                path.skip();
            }
        },
    };
    return { visitor };
};
exports.default = plugin;
